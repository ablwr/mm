#!/usr/bin/env bash

# verifypackage checks the validity of files created with makebroadcast,
# makeyoutube, and makedvd

SCRIPTDIR=$(dirname "${0}")
. "${SCRIPTDIR}/mmfunctions" || { echo "Missing '${SCRIPTDIR}/mmfunctions'. Exiting." ; exit 1 ; }
DEPENDENCIES=(mediaconch xmlstarlet)
_initialize_make

#input the package
while [ "${*}" != "" ] ; do
    PACKAGE="${1}"
    MEDIAID=$(basename "${PACKAGE}")
    shift
    #verify objects files
    while read OBJECT_FILE ; do
        STATUS=$(mediaconch --force -fx -p "${SCRIPTDIR}/object_policies.xml" "${OBJECT_FILE}" | xmlstarlet sel -N mc="https://mediaarea.net/mediaconch" -t -v mc:MediaConch/mc:media/mc:policy/@outcome -n)
        if [[ "$STATUS" = "pass" ]] ; then
            _report -dt "Pass: ${OBJECT_FILE}"
        else
            mediaconch --force -fs -p "${SCRIPTDIR}/object_policies.xml" "${OBJECT_FILE}"
        fi
    done < <(find "${PACKAGE}/objects" -type f -size +0 "${OBJECTS_FIND_EXCLUSIONS[@]}")
    #verify the makebroadcast file
    if [ -f "${PACKAGE}/objects/service/${MEDIAID}.mov" ] ; then
        STATUS=$(mediaconch --force -fx -p "${SCRIPTDIR}/makebroadcast_policies.xml" "${PACKAGE}/objects/service/${MEDIAID}.mov" | xmlstarlet sel -N mc="https://mediaarea.net/mediaconch" -t -v mc:MediaConch/mc:media/mc:policy/@outcome -n)
        if [[ "$STATUS" = "pass" ]] ; then
            _report -dt "Pass: ${PACKAGE}/objects/service/${MEDIAID}.mov"
        else
            mediaconch --force -fs -p "${SCRIPTDIR}/makebroadcast_policies.xml" "${PACKAGE}/objects/service/${MEDIAID}.mov"
        fi
    fi
    #verify the makeyoutube file
    if [ -f "${PACKAGE}/objects/access/youtube_up/${MEDIAID}.mp4" ] ; then
        STATUS=$(mediaconch --force -fx -p "${SCRIPTDIR}/makeyoutube_policies.xml" "${PACKAGE}/objects/access/youtube_up/${MEDIAID}.mp4" | xmlstarlet sel -N mc="https://mediaarea.net/mediaconch" -t -v mc:MediaConch/mc:media/mc:policy/@outcome -n)
        if [[ "$STATUS" = "pass" ]] ; then
            _report -dt "Pass: ${PACKAGE}/objects/access/youtube_up/${MEDIAID}.mp4"
        else
            mediaconch --force -fs -p "${SCRIPTDIR}/makeyoutube_policies.xml" "${PACKAGE}/objects/access/youtube_up/${MEDIAID}.mp4"
        fi
    fi
    #verify the makedvd file
    if [ -f "${PACKAGE}/objects/access/dvd/${MEDIAID}.iso" ] ; then
        STATUS=$(mediaconch --force -fx -p "${SCRIPTDIR}/makedvd_policies.xml" "${PACKAGE}/objects/access/dvd/${MEDIAID}.iso" | xmlstarlet sel -N mc="https://mediaarea.net/mediaconch" -t -v mc:MediaConch/mc:media/mc:policy/@outcome -n)
        if [[ "$STATUS" = "pass" ]] ; then
            _report -dt "Pass: ${PACKAGE}/objects/access/dvd/${MEDIAID}.iso"
        else
            mediaconch --force -fs -p "${SCRIPTDIR}/makedvd_policies.xml" "${PACKAGE}/objects/access/dvd/${MEDIAID}.iso"
        fi
    fi
done
